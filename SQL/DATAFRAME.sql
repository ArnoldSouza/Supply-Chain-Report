/* DECLARAÇÃO INICIAL DE CONFIGURAÇÃO */
SET NOCOUNT ON
/*  INTERVALO PRA GERAÇÃO DE SÉRIE ],]  */
DECLARE @filial varchar(2) = {filial}
DECLARE @armazem varchar(2) = {armazem}
DECLARE @codigo varchar(8) = {codigo}
DECLARE @dateFrom datetime = DATEADD(DAY,{intervalo},CONVERT(DATE, GETDATE()))
DECLARE @dateTo datetime = CONVERT(DATE, GETDATE())
/* CHECA SE A TABELA TEMPORÁRIA #movimentos JÁ EXISTE E A DELETA */
IF OBJECT_ID('tempdb..#movimentos') IS NOT NULL DROP TABLE #movimentos
/* -------------------------------------------------------------------------- */
/* --------------- INICIA CALCULO DE MOVIMENTOS ----------------------------- */
/* -------------------------------------------------------------------------- */
-- ALOCA O RESULTADO DE TODA A CONSULTA PARA A TABELA TEMPORARIA @MOVIMENTOS
SELECT TEMPORARIA.*
INTO #movimentos
FROM
	(
		/*  ENTRADA POR PRÉ-NOTA */
		SELECT
			SD1010.D1_FILIAL AS 'FIL',
			SD1010.D1_LOCAL AS 'LOC',
			CAST(SF1010.F1_DTDIGIT AS DATETIME) AS 'DT',
			SD1010.D1_DOC AS 'DOC',
			'NF' AS 'TP_DOC',
			SD1010.D1_TES AS 'TM_TES',
			RTRIM(SD1010.D1_COD) AS 'COD',
			SUM(SD1010.D1_QUANT) AS 'QTD',
			SUM(SD1010.D1_TOTAL) AS 'VAL',
			'ENTRADA' AS 'MOV',
			CASE WHEN RTRIM(SD1010.D1_CLVL)='001' THEN 'PN IVST' WHEN RTRIM(SD1010.D1_NFORI)<>'' THEN 'ESTN' ELSE 'PN CUST' END AS 'TP_MOV',
			CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATU_STK',
			RTRIM(SF1010.F1_NMUSER) AS 'USER_MOV',
			CASE WHEN RTRIM(SD1010.D1_NFORI)<>'' THEN 'ESTORNO DE DOCUMENTO | NF ORIGEM: '+RTRIM(SD1010.D1_NFORI) ELSE 'PC: '+RTRIM(SD1010.D1_PEDIDO)+' | USER INCLU: '+RTRIM(SF1010.F1_NMUSER)+' | USER CLA: '+RTRIM(SF1010.F1_NMCLASS) END AS 'OBS'
		FROM PROTHEUS.dbo.SD1010 SD1010
			LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA AND SF1010.D_E_L_E_T_<>'*'
			LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES  AND SF4010.D_E_L_E_T_<>'*'
			LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON SA2010.A2_COD=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SA2010.A2_LOJA AND SA2010.D_E_L_E_T_<>'*'
		WHERE
			(SD1010.D1_QUANT<>0) AND --RETIRA ENTRADAS DE FRETE (QTD=0 MAS COM VALOR) 
			(SD1010.D_E_L_E_T_<>'*') AND --SEM DELET
			(SD1010.D1_FILIAL= @filial AND SD1010.D1_LOCAL= @armazem) AND --LOCAL E FILIAL
			(LEFT(SA2010.A2_CGC,8)<>'05061494') AND --RETIRA ENDICON
			(
				(SF1010.F1_DTDIGIT>@dateFrom AND SF1010.F1_DTDIGIT<= @dateTo) AND --ESPECIFICA TEMPO
				(
					(SF4010.F4_ESTOQUE='S') --DESCONSIDERA NF'S PENDENTES DE CLASSIFICAÇÃO
					--((SF4010.F4_ESTOQUE='S') OR (SF4010.F4_CODIGO='103' OR SF4010.F4_CODIGO='140')) OR (SD1010.D1_CC='          ' AND SD1010.D1_TES='   ') --CONSIDERA TAMBÉM NF'S NÃO CLASSIFICADAS
				)
			) AND
			SD1010.D1_COD = @codigo
		GROUP BY
			SD1010.D1_FILIAL,
			SD1010.D1_LOCAL,
			CAST(SF1010.F1_DTDIGIT AS DATETIME),
			SD1010.D1_DOC,
			SD1010.D1_TES,
			RTRIM(SD1010.D1_COD),
			SD1010.D1_DESCRI,
			CASE WHEN RTRIM(SD1010.D1_CLVL)='001' THEN 'PN IVST' WHEN RTRIM(SD1010.D1_NFORI)<>'' THEN 'ESTN' ELSE 'PN CUST' END,
			SF4010.F4_ESTOQUE,
			RTRIM(SF1010.F1_NMUSER),
			CASE WHEN RTRIM(SD1010.D1_NFORI)<>'' THEN 'ESTORNO DE DOCUMENTO | NF ORIGEM: '+RTRIM(SD1010.D1_NFORI) ELSE 'PC: '+RTRIM(SD1010.D1_PEDIDO)+' | USER INCLU: '+RTRIM(SF1010.F1_NMUSER)+' | USER CLA: '+RTRIM(SF1010.F1_NMCLASS) END
		Union ALL
		/* -- MOVIMENTOS POR TRANSFERÊNCIA INTERNA */
		SELECT
			SD3010.D3_FILIAL AS 'FIL',
			SD3010.D3_LOCAL AS 'LOC',
			CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DT',
			SD3010.D3_DOC AS 'DOC',
			'RM-TI' AS 'TP_DOC',
			SD3010.D3_TM AS 'TM_TES',
			RTRIM(SD3010.D3_COD) AS 'COD',
			CASE WHEN SD3010.D3_TM = '499' THEN SUM(SD3010.D3_QUANT) WHEN SD3010.D3_TM = '999' THEN SUM(SD3010.D3_QUANT*-1) END AS 'QTD',
			CASE WHEN SD3010.D3_TM = '499' THEN SUM(SB1010.B1_UPRC*SD3010.D3_QUANT)  WHEN SD3010.D3_TM = '999' THEN SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)*-1) END AS 'VAL', --ULT. PREÇ. COMPRA,
			CASE WHEN SD3010.D3_TM < '500' THEN 'ENTRADA' ELSE 'SAÍDA' END AS 'MOV',
			CASE
				WHEN (SD3010.D3_DOC='INVENT' AND SD3010.D3_TM = '499')
					THEN 'INVENT-E'
				WHEN (SD3010.D3_DOC='INVENT' AND SD3010.D3_TM = '999')
					THEN 'INVENT-S'
				WHEN SD3010.D3_TM = '499'
					THEN 'TRASF_INT-E'
				WHEN SD3010.D3_TM = '999'
					THEN 'TRASF_INT-S'
			END AS 'TP_MOV',
			'SIM' AS 'ATU_STK',
			RTRIM(SD3010.D3_USUARIO) AS 'USER_MOV',
			CASE
				WHEN SD3010.D3_DOC='INVENT'
					THEN 'INVENT USER: '+RTRIM(SD3010.D3_USUARIO)
				WHEN SD3010.D3_TM = '499'
					THEN
						RTRIM(ENTRADA.Z22_FILIAL+ENTRADA.Z22_ALMORI)+'->'+RTRIM(ENTRADA.Z22_FILIAL+ENTRADA.Z22_ALMDES)+' | DOC TRF:'+RTRIM(ENTRADA.Z22_DOC)+
						' - DOC SD3: '+RTRIM(ENTRADA.Z22_SD3DOC)+' SOLIC: '+RTRIM(ENTRADA.Z22_USUARI)+' OBS: '+RTRIM(ENTRADA.Z22_OBS)
				WHEN SD3010.D3_TM = '999'
					THEN
						RTRIM(SAIDA.Z22_FILIAL+SAIDA.Z22_ALMORI)+'->'+RTRIM(SAIDA.Z22_FILIAL+SAIDA.Z22_ALMDES)+' | DOC TRF:'+RTRIM(SAIDA.Z22_DOC)+
						' - DOC SD3: '+RTRIM(SAIDA.Z22_SD3DOC)+' SOLIC: '+RTRIM(SAIDA.Z22_USUARI)+' OBS: '+RTRIM(SAIDA.Z22_OBS)
			END AS 'OBS'
		FROM PROTHEUS.dbo.SD3010 SD3010
			LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
			--JOIN ENTRADA: 499
			LEFT JOIN PROTHEUS.dbo.Z22010 ENTRADA ON
				(ENTRADA.D_E_L_E_T_<>'*') AND
				(ENTRADA.Z22_FILIAL+ENTRADA.Z22_ALMDES=SD3010.D3_FILIAL+SD3010.D3_LOCAL) AND
				(ENTRADA.Z22_SD3DOC=SD3010.D3_DOC) AND
				(ENTRADA.Z22_PRDDES=SD3010.D3_COD) AND
				(ENTRADA.Z22_APROV='L')
			--JOIN SAIDA: 999
			LEFT JOIN PROTHEUS.dbo.Z22010 SAIDA ON
				(SAIDA.D_E_L_E_T_<>'*') AND
				(SAIDA.Z22_FILIAL+SAIDA.Z22_ALMORI=SD3010.D3_FILIAL+SD3010.D3_LOCAL) AND
				(SAIDA.Z22_SD3DOC=SD3010.D3_DOC) AND
				(SAIDA.Z22_PRDDES=SD3010.D3_COD) AND
				(SAIDA.Z22_APROV='L')
		WHERE
			(SD3010.D_E_L_E_T_<>'*') AND
			(SD3010.D3_ESTORNO='') AND
			(SD3010.D3_TM='499' OR SD3010.D3_TM='999') AND
			((SD3010.D3_EMISSAO>@dateFrom) AND (SD3010.D3_EMISSAO<= @dateTo)) AND
			SD3010.D3_FILIAL = @filial AND
			SD3010.D3_LOCAL= @armazem AND
			SD3010.D3_COD = @codigo
		GROUP BY
			SD3010.D3_FILIAL,
			SD3010.D3_LOCAL,
			CAST(SD3010.D3_EMISSAO AS DATETIME),
			SD3010.D3_DOC,
			SD3010.D3_TM,
			RTRIM(SD3010.D3_COD),
			CASE
				WHEN (SD3010.D3_DOC='INVENT' AND SD3010.D3_TM = '499')
					THEN 'INVENT-E'
				WHEN (SD3010.D3_DOC='INVENT' AND SD3010.D3_TM = '999')
					THEN 'INVENT-S'
				WHEN SD3010.D3_TM = '499'
					THEN 'TRASF_INT-E'
				WHEN SD3010.D3_TM = '999'
					THEN 'TRASF_INT-S'
			END,
			RTRIM(SD3010.D3_USUARIO),
			CASE
				WHEN SD3010.D3_DOC='INVENT'
					THEN 'INVENT USER: '+RTRIM(SD3010.D3_USUARIO)
				WHEN SD3010.D3_TM = '499'
					THEN
						RTRIM(ENTRADA.Z22_FILIAL+ENTRADA.Z22_ALMORI)+'->'+RTRIM(ENTRADA.Z22_FILIAL+ENTRADA.Z22_ALMDES)+' | DOC TRF:'+RTRIM(ENTRADA.Z22_DOC)+
						' - DOC SD3: '+RTRIM(ENTRADA.Z22_SD3DOC)+' SOLIC: '+RTRIM(ENTRADA.Z22_USUARI)+' OBS: '+RTRIM(ENTRADA.Z22_OBS)
				WHEN SD3010.D3_TM = '999'
					THEN
						RTRIM(SAIDA.Z22_FILIAL+SAIDA.Z22_ALMORI)+'->'+RTRIM(SAIDA.Z22_FILIAL+SAIDA.Z22_ALMDES)+' | DOC TRF:'+RTRIM(SAIDA.Z22_DOC)+
						' - DOC SD3: '+RTRIM(SAIDA.Z22_SD3DOC)+' SOLIC: '+RTRIM(SAIDA.Z22_USUARI)+' OBS: '+RTRIM(SAIDA.Z22_OBS)
			END
		Union ALL
		/* -- MOVIMENTOS POR TRANSFERÊNCIA EXTERNA - ENTRADA*/
		SELECT
			SD1010.D1_FILIAL AS 'FIL',
			SD1010.D1_LOCAL AS 'LOC',
			CAST(SF1010.F1_DTDIGIT AS DATETIME) AS 'DT',
			RTRIM(SD1010.D1_DOC)+'-'+RTRIM(SD1010.D1_SERIE) AS 'DOC',
			'NF-SR' AS 'TP_DOC',
			SD1010.D1_TES AS 'TM_TES',
			RTRIM(SD1010.D1_COD) AS 'COD',
			SUM(SD1010.D1_QUANT) AS 'QTD',
			SUM(SD1010.D1_TOTAL) AS 'VAL',
			'ENTRADA' AS 'MOV',
			'TRASF_EXT-E' AS 'TP_MOV',
			CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATU_STK',
			RTRIM(SC5010.C5_USUINL) AS 'USER_MOV',
			CASE WHEN SD1010.D1_SERIE='40' THEN 'TRANSF FILIAL PARA FILIAL' ELSE 'PV: '+RTRIM(SC5010.C5_NUM) + ' | USER: ' + RTRIM(SC5010.C5_USUINL) + ' | OBS: ' + RTRIM(SC5010.C5_MENNOTA) END AS 'OBS'
		FROM PROTHEUS.dbo.SD1010 SD1010
			LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SD1010.D1_FILIAL+SD1010.D1_LOCAL) AND Z01010.D_E_L_E_T_<>'*'
			LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD1010.D1_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_<>'*'
			LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_<>'*'
			LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES AND SF4010.D_E_L_E_T_<>'*'
			LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA AND SF1010.D_E_L_E_T_<>'*'
			LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON SA2010.A2_COD=SD1010.D1_FORNECE AND SD1010.D1_LOJA=SA2010.A2_LOJA AND SA2010.D_E_L_E_T_<>'*'
			--LINK COM GERAÇÃO DE PV PARA SAÍDA
			LEFT JOIN PROTHEUS.dbo.SC5010 SC5010 ON SD1010.D1_DOC=SC5010.C5_NOTA AND SD1010.D1_SERIE=SC5010.C5_SERIE AND SC5010.C5_FILIAL='02' AND SC5010.D_E_L_E_T_<>'*'
		WHERE
			(SD1010.D_E_L_E_T_<>'*') AND
			(SD1010.D1_FILIAL= @filial AND SD1010.D1_LOCAL= @armazem) AND
			(LEFT(SA2010.A2_CGC,8)='05061494') AND
			(
				(SF1010.F1_DTDIGIT>@dateFrom AND SF1010.F1_DTDIGIT<= @dateTo) AND
				(
					(SF4010.F4_ESTOQUE='S')
					-- ((SF4010.F4_ESTOQUE='S') OR (SF4010.F4_CODIGO='103' OR SF4010.F4_CODIGO='140')) OR
					-- (SD1010.D1_CC='          ' AND SD1010.D1_TES='   ')
				)
			) AND
			SD1010.D1_COD = @codigo
		GROUP BY
			SD1010.D1_FILIAL,
			SD1010.D1_LOCAL,
			CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
			CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
			CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
			SD1010.D1_FILIAL+SD1010.D1_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
			SUBSTRING(SF1010.F1_DTDIGIT,5,2)+' - '+LEFT(SF1010.F1_DTDIGIT,4),
			SF1010.F1_DTDIGIT,
			RTRIM(SD1010.D1_DOC)+'-'+RTRIM(SD1010.D1_SERIE),
			SD1010.D1_TES,
			SB1010.B1_GRUPO,
			SBM010.BM_DESC,
			SD1010.D1_COD,
			SD1010.D1_DESCRI,
			SD1010.D1_CLVL,
			SF4010.F4_ESTOQUE,
			CASE WHEN SD1010.D1_SERIE='40' THEN 'TRANSF FILIAL PARA FILIAL' ELSE 'PV: '+RTRIM(SC5010.C5_NUM) + ' | USER: ' + RTRIM(SC5010.C5_USUINL) + ' | OBS: ' + RTRIM(SC5010.C5_MENNOTA) END,
			RTRIM(SC5010.C5_USUINL)
		UNION ALL
		/* -- MOVIMENTOS POR TRANSFERÊNCIA EXTERNA - SAÍDA*/
		SELECT
			SD2010.D2_FILIAL AS 'FIL',
			SD2010.D2_LOCAL AS 'LOC',
			CAST(SD2010.D2_EMISSAO AS DATETIME) AS 'DT',
			RTRIM(SD2010.D2_DOC)+'-'+RTRIM(SD2010.D2_SERIE) AS 'DOC',
			'NF-SR' AS 'TP_DOC',
			SD2010.D2_TES AS 'TM_TES',
			RTRIM(SD2010.D2_COD) AS 'COD',
			CASE WHEN SD2010.D2_TIPO = 'D' THEN SUM(SD2010.D2_QUANT*-1) ELSE SUM(SD2010.D2_QUANT*-1) END AS 'QTD',
			CASE WHEN SD2010.D2_TIPO = 'D' THEN SUM(SD2010.D2_TOTAL*-1) ELSE SUM(SD2010.D2_TOTAL*-1) END AS 'VAL',
			'SAÍDA' AS 'MOV',
			CASE WHEN SD2010.D2_TIPO = 'D' THEN 'TRASF_EXT-DEV' ELSE 'TRASF_EXT-S' END AS 'TP_MOV',
			CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATU_STK',
			RTRIM(SC5010.C5_USUINL)  AS 'USER_MOV',
			CASE WHEN RTRIM(SD2010.D2_NFORI)<>'' THEN 'NF ORIGEM: '+RTRIM(SD2010.D2_NFORI)+' | PV: '+RTRIM(SC5010.C5_NUM) + ' | USER: ' + RTRIM(SC5010.C5_USUINL) WHEN SD2010.D2_SERIE='40' THEN 'TRANSF FILIAL PARA FILIAL' ELSE SD2010.D2_FILIAL+SD2010.D2_LOCAL+'->'+SC5010.C5_FILDEST+SC5010.C5_LOCDEST+' | PV: '+RTRIM(SC5010.C5_NUM) + ' | USER: ' + RTRIM(SC5010.C5_USUINL) + ' | OBS: ' + RTRIM(SC5010.C5_MENNOTA) END AS 'OBS'
		FROM PROTHEUS.dbo.SD2010 SD2010
			LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER=(SD2010.D2_FILIAL+SD2010.D2_LOCAL) AND Z01010.D_E_L_E_T_ <> '*'
			LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD2010.D2_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
			LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*'
			LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD2010.D2_TES AND SF4010.D_E_L_E_T_ <> '*'
			--LINK COM GERAÇÃO DE PV PARA SAÍDA
			LEFT JOIN PROTHEUS.dbo.SC5010 SC5010 ON SC5010.C5_NOTA=SD2010.D2_DOC AND SD2010.D2_SERIE=SC5010.C5_SERIE AND SC5010.C5_FILIAL=SD2010.D2_FILIAL AND SC5010.D_E_L_E_T_<>'*'
		WHERE
			SD2010.D_E_L_E_T_<>'*' AND
			(SD2010.D2_EMISSAO>@dateFrom AND SD2010.D2_EMISSAO<= @dateTo) AND
			SF4010.F4_ESTOQUE='S' AND
			SD2010.D2_FILIAL = @filial AND
			SD2010.D2_LOCAL= @armazem AND
			SD2010.D2_COD = @codigo
		GROUP BY
			SD2010.D2_FILIAL,
			SD2010.D2_LOCAL,
			CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
			CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
			CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
			SD2010.D2_FILIAL+SD2010.D2_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
			CAST(SD2010.D2_EMISSAO AS DATETIME),
			RTRIM(SD2010.D2_DOC)+'-'+RTRIM(SD2010.D2_SERIE),
			SD2010.D2_TES,
			SB1010.B1_GRUPO,
			SBM010.BM_DESC,
			RTRIM(SD2010.D2_COD),
			SB1010.B1_DESC,
			SD2010.D2_TIPO,
			SF4010.F4_ESTOQUE,
			RTRIM(SC5010.C5_USUINL),
			CASE WHEN RTRIM(SD2010.D2_NFORI)<>'' THEN 'NF ORIGEM: '+RTRIM(SD2010.D2_NFORI)+' | PV: '+RTRIM(SC5010.C5_NUM) + ' | USER: ' + RTRIM(SC5010.C5_USUINL) WHEN SD2010.D2_SERIE='40' THEN 'TRANSF FILIAL PARA FILIAL' ELSE SD2010.D2_FILIAL+SD2010.D2_LOCAL+'->'+SC5010.C5_FILDEST+SC5010.C5_LOCDEST+' | PV: '+RTRIM(SC5010.C5_NUM) + ' | USER: ' + RTRIM(SC5010.C5_USUINL) + ' | OBS: ' + RTRIM(SC5010.C5_MENNOTA) END
		Union ALL
		/* -- MOVIMENTOS SOLICITAÇÃO AO ARMAZÉM - SAÍDA */
		SELECT
			SD3010.D3_FILIAL AS 'FIL',
			SD3010.D3_LOCAL AS 'LOC',
			CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DT',
			SD3010.D3_DOC AS 'DOC',
			'RM-SA' AS 'TP_DOC',
			SD3010.D3_TM AS 'TM_TES',
			RTRIM(SD3010.D3_COD) AS 'COD',
			SUM(SD3010.D3_QUANT*-1) AS 'QTD',
			SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)*-1) AS 'VAL', --VALORIZADO POR UPC, NÃO PEGA AS CORREÇÕES DE VALOR TOTAL
			'SAÍDA' AS 'MOV',
			CASE
				WHEN SD3010.D3_TM = '501' AND RTRIM(SD3010.D3_CLVL)='001' THEN 'SA-INVEST'
				WHEN SD3010.D3_TM = '501' AND RTRIM(SD3010.D3_CLVL)<>'001' THEN 'SA-CUSTO'
				WHEN SD3010.D3_TM = '502' THEN 'SA-CLIENTE'
				WHEN SD3010.D3_TM = '503' THEN 'AJUSTE STK'
				WHEN SD3010.D3_TM = '505' THEN 'SA-ATIVO'
				WHEN SD3010.D3_TM = '506' THEN 'SA-S/APP'
				WHEN SD3010.D3_TM = '507' THEN 'SA-RECONDICIONADO'
				ELSE 'ERRO-TM NOVA'
			END AS 'TP_MOV',
			'SIM' AS 'ATU_STK',
			RTRIM(SD3010.D3_USUARIO)  AS 'USER_MOV',
			'SA: '+RTRIM(SCQ010.CQ_NUM)+' | SOLIC: '+RTRIM(SCP010.CP_SOLICIT)+' | OBS: '+RTRIM(SCP010.CP_OBS)+' | MAT: '+ CASE WHEN SCP010.CP_FORNECE='      ' THEN '' ELSE RTRIM(SCP010.CP_FORNECE)+'-'+RTRIM(SA2010.A2_NOME) END AS 'OBS'
		FROM PROTHEUS.dbo.SD3010 SD3010
			LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
			--DADOS DE SA
			LEFT JOIN PROTHEUS.dbo.SCQ010 SCQ010 ON SD3010.D3_NUMSEQ=SCQ010.CQ_NUMREQ AND SCQ010.D_E_L_E_T_ <> '*'
			LEFT JOIN PROTHEUS.dbo.SCP010 SCP010 ON SCP010.CP_NUM+SCP010.CP_ITEM=SCQ010.CQ_NUM+SCQ010.CQ_ITEM AND SCP010.D_E_L_E_T_ <> '*'
			LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON  SA2010.A2_COD=SCP010.CP_FORNECE AND SA2010.D_E_L_E_T_ <> '*'
		WHERE
			(SD3010.D_E_L_E_T_<>'*') AND
			(LEFT(SD3010.D3_CF,2) = 'RE') AND
			(SD3010.D3_ESTORNO='') AND
			(SD3010.D3_TM<>'999') AND
			((SD3010.D3_EMISSAO>@dateFrom) AND (SD3010.D3_EMISSAO<= @dateTo)) AND
			SD3010.D3_FILIAL = @filial AND
			SD3010.D3_LOCAL= @armazem AND
			SD3010.D3_COD = @codigo
		GROUP BY
			SD3010.D3_FILIAL,
			SD3010.D3_LOCAL,
			CAST(SD3010.D3_EMISSAO AS DATETIME),
			SD3010.D3_DOC,
			SD3010.D3_TM,
			SB1010.B1_GRUPO,
			SD3010.D3_COD,
			SB1010.B1_DESC,
			SD3010.D3_TM,
			SD3010.D3_CLVL,
			--COMPLEMENTO DE GROUP BY
			SD3010.D3_EMISSAO,
			RTRIM(SD3010.D3_USUARIO),
			'SA: '+RTRIM(SCQ010.CQ_NUM)+' | SOLIC: '+RTRIM(SCP010.CP_SOLICIT)+' | OBS: '+RTRIM(SCP010.CP_OBS)+' | MAT: '+ CASE WHEN SCP010.CP_FORNECE='      ' THEN '' ELSE RTRIM(SCP010.CP_FORNECE)+'-'+RTRIM(SA2010.A2_NOME) END
		Union ALL
		/* -- MOVIMENTOS SOLICITAÇÃO AO ARMAZÉM - ENTRADA */
		SELECT
			SD3010.D3_FILIAL AS 'FIL',
			SD3010.D3_LOCAL AS 'LOC',
			CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DT',
			SD3010.D3_DOC AS 'DOC',
			'RM-DEV' AS 'TP_DOC',
			SD3010.D3_TM AS 'TM_TES',
			RTRIM(SD3010.D3_COD) AS 'COD',
			SUM(SD3010.D3_QUANT) AS 'QTD',
			SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)) AS 'VAL', --VALORIZADO POR UPC, NÃO PEGA AS CORREÇÕES DE VALOR TOTAL
			'ENTRADA' AS 'MOV',
			CASE
				WHEN SD3010.D3_TM = '001' AND RTRIM(SD3010.D3_CLVL)='001' THEN 'SA-INVEST'
				WHEN SD3010.D3_TM = '001' AND RTRIM(SD3010.D3_CLVL)<>'001' THEN 'SA-CUSTO'
				WHEN SD3010.D3_TM = '002' THEN 'SA-CLIENTE'
				WHEN SD3010.D3_TM = '003' THEN 'AJUSTE STK'
				WHEN SD3010.D3_TM = '005' THEN 'SA-ATIVO'
				WHEN SD3010.D3_TM = '006' THEN 'SA-S/APP'
				WHEN SD3010.D3_TM = '007' THEN 'SA-RECONDICIONADO'
				ELSE 'ERRO-TM NOVA'
			END AS 'TP_MOV',
			'SIM' AS 'ATU_STK',
			RTRIM(SD3010.D3_USUARIO) AS 'USER_MOV',
			'USER: '+RTRIM(SD3010.D3_USUARIO)+' | CC: '+RTRIM(SD3010.D3_CC)+'-'+RTRIM(CTT010.CTT_DESC01)+' | OBS: '+RTRIM(SD3010.D3_MEMO) AS 'OBS'
		FROM PROTHEUS.dbo.SD3010 SD3010
			LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
			LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 ON SD3010.D3_CC=CTT010.CTT_CUSTO AND CTT010.D_E_L_E_T_ <> '*'
		WHERE
			(SD3010.D_E_L_E_T_<>'*') AND
			(LEFT(SD3010.D3_CF,2) = 'DE') AND
			(SD3010.D3_ESTORNO='') AND
			--(SD3010.D3_DOC NOT LIKE '%INVENT%') AND
			(SD3010.D3_TM<>'499') AND
			((SD3010.D3_EMISSAO>@dateFrom) AND (SD3010.D3_EMISSAO<= @dateTo)) AND
			SD3010.D3_FILIAL = @filial AND
			SD3010.D3_LOCAL= @armazem AND
			SD3010.D3_COD = @codigo
		GROUP BY
			SD3010.D3_FILIAL,
			SD3010.D3_LOCAL,
			CAST(SD3010.D3_EMISSAO AS DATETIME),
			SD3010.D3_DOC,
			SD3010.D3_TM,
			SD3010.D3_COD,
			SD3010.D3_TM,
			SD3010.D3_CLVL,
			'USER: '+RTRIM(SD3010.D3_USUARIO)+' | CC: '+RTRIM(SD3010.D3_CC)+'-'+RTRIM(CTT010.CTT_DESC01)+' | OBS: '+RTRIM(SD3010.D3_MEMO),
			RTRIM(SD3010.D3_USUARIO)
	) TEMPORARIA
/* -------------------------------------------------------------------------- */
/* ---------------- TERMINA CALCULO DE MOVIMENTOS --------------------------- */
/* -------------------------------------------------------------------------- */
/*  DECLARA TABELA TEMPORÁRIA  */
DECLARE @dates TABLE(datas datetime) 
WHILE(@dateFrom < @dateTo)
BEGIN
   SELECT @dateFrom = DATEADD(day, 1,@dateFrom)
   INSERT INTO @dates 
   SELECT @dateFrom
END 
/*  SELECT DADOS FINAL  */
SELECT
	datas AS DT,
	SUM(CASE WHEN #movimentos.MOV='ENTRADA' THEN 1 ELSE 0 END) AS TRANSACT_ENTRA, --CONTA ENTRADA
	SUM(CASE WHEN #movimentos.MOV='SAÍDA' THEN 1 ELSE 0 END) AS TRANSACT_SAI, --CONTA SAÍDA
	SUM(CASE WHEN #movimentos.MOV ='ENTRADA' THEN QTD ELSE 0 END) AS SOMA_ENTRA, --SOMA ENTRADA
	SUM(CASE WHEN #movimentos.MOV ='SAÍDA' THEN QTD ELSE 0 END) AS SOMA_SAI --SOMA SAÍDA
FROM @dates
	LEFT JOIN #movimentos ON [@dates].datas = #movimentos.DT
GROUP BY datas
ORDER BY datas
/* FINALIZA ELIMINANDO A TABELA TEMPORÁRIA */
DROP TABLE #movimentos